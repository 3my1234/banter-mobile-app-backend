// Prisma schema for Banter Mobile App Backend
// Database: PostgreSQL (banter_db)
// Primary Key Strategy: Privy DID for unified identity across Banter and Rolley

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Primary key is Privy DID for cross-app compatibility
model User {
  id              String   @id @default(cuid())
  email           String?  @unique // Email (fallback identifier)
  displayName     String?
  username        String?  @unique
  solanaAddress   String?  @unique
  movementAddress String?  @unique
  avatarUrl       String?  // Profile picture URL
  bannerUrl       String?  // Profile banner URL
  bio             String?
  phone           String?
  country         String?
  dateOfBirth     DateTime?
  clubs           String[] @default([])
  voteBalance     Int      @default(0)
  rolBalanceRaw   BigInt   @default(0) // Off-chain ROL rewards, raw units (8 decimals)
  lastDailyRolAt  DateTime?
  
  // Relations
  wallets         Wallet[]
  posts           Post[]
  votes           Vote[]
  comments        Comment[]
  reactions       Reaction[]
  payments        Payment[]
  notifications   Notification[]
  pcaVotes        PcaVote[]
  followers       Follow[] @relation("UserFollowers")
  following       Follow[] @relation("UserFollowing")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([email])
  @@index([username])
}

// Wallet model - Supports Movement and Solana
model Wallet {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Wallet identifiers
  privyWalletId   String?  // Privy wallet ID
  address         String   // Wallet address
  blockchain      Blockchain
  
  // Wallet metadata
  type            String?  // e.g., PRIVY_EMBEDDED, PRIVY_EXTERNAL
  walletClient    String?  // e.g., APTOS_EMBEDDED, SOLANA_EMBEDDED
  isPrimary       Boolean  @default(false)
  encryptedPrivateKey String?
  
  // Relations
  walletBalances  WalletBalance[]
  walletTransactions WalletTransaction[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, blockchain, address]) // One wallet per user per blockchain per address
  @@index([userId])
  @@index([blockchain])
  @@index([address])
}

enum Blockchain {
  MOVEMENT
  SOLANA
}

// Post model - Banter posts with 24-hour expiration
model Post {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  repostOfId      String?
  repostOf        Post?    @relation("PostReposts", fields: [repostOfId], references: [id], onDelete: SetNull)
  reposts         Post[]   @relation("PostReposts")
  
  content         String
  imageUrl        String?  // Deprecated: use mediaUrl instead
  mediaUrl        String?  // Image or video URL
  mediaType       String?  // "image" or "video"
  isRoast         Boolean  @default(false) // Is this a roast post?
  
  // Voting counts
  stayVotes       Int      @default(0)
  dropVotes       Int      @default(0)
  shareCount      Int      @default(0)
  repostCount     Int      @default(0)
  
  // Tags and League
  tags            String[] // Array of club tags / hashtags
  league          String?  // League name (e.g., "Premier League", "La Liga")
  
  // Status
  status          PostStatus @default(ACTIVE)
  expiresAt       DateTime   // 24 hours from creation
  hiddenAt        DateTime?  // When post was hidden (dropped)
  
  // Relations
  votes           Vote[]
  comments        Comment[]
  reactions       Reaction[]
  postTags        PostTag[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@index([league])
  @@index([isRoast])
  @@index([repostOfId])
  @@unique([userId, repostOfId])
}

// Follow model - User following relationships
model Follow {
  id           String   @id @default(cuid())
  followerId   String
  follower     User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  followingId  String
  following    User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

enum PostStatus {
  ACTIVE
  HIDDEN
  EXPIRED
}

// Vote model - Stay/Drop votes on posts
model Vote {
  id              String   @id @default(cuid())
  postId          String
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  voteType        VoteType // STAY or DROP
  
  createdAt       DateTime @default(now())
  
  @@unique([postId, userId]) // One vote per user per post
  @@index([postId])
  @@index([userId])
}

enum VoteType {
  STAY
  DROP
}

// Comment model - Comments on posts
model Comment {
  id              String   @id @default(cuid())
  postId          String
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  parentId        String?
  parent          Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")

  content         String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([postId])
  @@index([userId])
  @@index([parentId])
}

// Reaction model - Reactions on posts (like, love, laugh, etc.)
model Reaction {
  id              String   @id @default(cuid())
  postId          String
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type            ReactionType
  
  createdAt       DateTime @default(now())
  
  @@unique([postId, userId]) // One reaction per user per post
  @@index([postId])
  @@index([userId])
}

enum ReactionType {
  LIKE
  LOVE
  LAUGH
  FIRE
  ANGRY
  SAD
}

// Tag model - Club tags / hashtags
model Tag {
  id              String   @id @default(cuid())
  name            String   @unique // Tag name (e.g., "arsenal", "manchester-united")
  displayName     String   // Display name (e.g., "Arsenal", "Manchester United")
  type            TagType  @default(CLUB) // CLUB or HASHTAG
  league          String?  // League this club belongs to
  iconUrl         String?  // Club logo/icon URL
  
  // Relations
  postTags        PostTag[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([name])
  @@index([type])
  @@index([league])
}

enum TagType {
  CLUB
  HASHTAG
}

// PostTag - Many-to-many relationship between Posts and Tags
model PostTag {
  id              String   @id @default(cuid())
  postId          String
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  tagId           String
  tag             Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  
  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

// League model - Football leagues
model League {
  id              String   @id @default(cuid())
  name            String   @unique // League name (e.g., "Premier League")
  displayName     String   // Display name
  country         String?  // Country (e.g., "England", "Spain")
  logoUrl         String?  // League logo URL
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([name])
  @@index([country])
}

// Wallet balance tracking (similar to reference implementation)
model WalletBalance {
  id              String   @id @default(cuid())
  walletId        String
  wallet          Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Token details
  tokenAddress    String   // Token contract address
  tokenSymbol     String   // e.g., "ROL", "SOL", "USDC"
  tokenName       String?
  decimals        Int      @default(8)
  
  // Balance
  balance         String   @default("0") // Stored as string for large numbers
  balanceUsd     Float?
  
  // Metadata
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([walletId, tokenAddress])
  @@index([walletId])
  @@index([tokenAddress])
  @@index([tokenSymbol])
}

// Wallet transaction history
model WalletTransaction {
  id              String   @id @default(cuid())
  walletId        String
  wallet          Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  txHash          String   @unique
  txType          String   // e.g., "TRANSFER", "RECEIVE", "SWAP"
  amount          String
  tokenAddress    String
  tokenSymbol     String
  fromAddress     String?
  toAddress       String?
  status          String   @default("COMPLETED")
  blockNumber     String?
  blockTime       DateTime?
  description     String?
  metadata        Json?
  paymentId       String?
  payment         Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([walletId])
  @@index([txHash])
  @@index([txType])
  @@index([blockTime])
  @@index([paymentId])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentChain {
  SOLANA
  MOVEMENT
  FLUTTERWAVE
}

enum PaymentType {
  VOTE_PURCHASE
  OTHER
}

enum NotificationType {
  SYSTEM
  VOTE_PURCHASE
  WALLET_RECEIVE
  WALLET_TRANSFER
  COMMENT_REPLY
  DAILY_ROL
  XP
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String
  body        String?
  data        Json?
  reference   String?          @unique
  readAt      DateTime?
  createdAt   DateTime         @default(now())

  @@index([userId, createdAt])
  @@index([type])
}

enum PcaSport {
  SOCCER
  BASKETBALL
}

enum PcaCategoryType {
  GOAL_OF_WEEK
  PLAYER_OF_MONTH
  TOURNAMENT_AWARD
  BALLON_DOR_PEOPLES_CHOICE
  CUSTOM
}

model PcaCategory {
  id           String          @id @default(cuid())
  sport        PcaSport
  season       String
  categoryType PcaCategoryType @default(CUSTOM)
  title        String
  subtitle     String?
  roundLabel   String?
  description  String?
  criteria     Json?
  isActive     Boolean         @default(true)
  startsAt     DateTime?
  endsAt       DateTime?
  nominees     PcaNominee[]
  votes        PcaVote[]
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([sport, season, isActive])
  @@index([categoryType])
}

model PcaNominee {
  id         String      @id @default(cuid())
  categoryId String
  category   PcaCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name       String
  team       String?
  country    String?
  position   String?
  imageUrl   String?
  videoUrl   String?
  stats      Json?
  voteCount  Int         @default(0)
  sortOrder  Int         @default(0)
  votes      PcaVote[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@index([categoryId, voteCount])
  @@index([sortOrder])
}

model PcaVote {
  id         String      @id @default(cuid())
  userId     String
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryId String
  category   PcaCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  nomineeId  String
  nominee    PcaNominee  @relation(fields: [nomineeId], references: [id], onDelete: Cascade)
  votes      Int         @default(1)
  createdAt  DateTime    @default(now())

  @@index([userId, createdAt])
  @@index([categoryId])
  @@index([nomineeId])
}

model Payment {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentType     PaymentType
  chain           PaymentChain
  amount          Float
  amountRaw       String
  currency        String
  tokenAddress    String
  fromAddress     String
  toAddress       String
  status          PaymentStatus @default(PENDING)
  txHash          String?
  metadata        Json?
  completedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  walletTransactions WalletTransaction[]

  @@index([userId])
  @@index([status])
  @@index([chain])
}
